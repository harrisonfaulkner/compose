volumes:
  monitoring:
  etc_wireguard:
  nfsmountCC:
    driver: local
    driver_opts:
      type: nfs
      o: nfsvers=4,addr=192.168.1.10,nolock,soft,rw
      device: ":/mnt/hdd-storage01/hdd-storage01"

services:
  nfs-health-check:
    image: busybox
    container_name: nfs-health-check
    volumes:
      - "nfsmountCC:/mnt/"
    command: sh -c "ls /mnt/ && exit 0"
    restart: "no"

  sonarr:
    image: ghcr.io/hotio/sonarr
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - /opt/sonarr/config:/config
      - "nfsmountCC:/mnt/"
    ports:
      - 8989:8989
    restart: unless-stopped
    depends_on:
      - nfs-health-check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  radarr:
    image: ghcr.io/hotio/radarr
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - /opt/radarr/config:/config
      - "nfsmountCC:/mnt/"
    ports:
      - 7878:7878
    restart: unless-stopped
    depends_on:
      - nfs-health-check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  sabnzbd:
    image: ghcr.io/hotio/sabnzbd
    container_name: sabnzbd
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - /opt/sabnzbd/config:/config
      - /media/processing/:/media/processing

      - "nfsmountCC:/mnt/"
    ports:
      - 8080:8080
    restart: unless-stopped
    depends_on:
      - nfs-health-check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api?mode=version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    environment:
      - LOG_LEVEL=debug
      - TZ=America/Chicago
      - PORT=5055
    ports:
      - 5055:5055
    volumes:
      - /opt/overseerr/config:/app/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  prowlarr:
    image: ghcr.io/hotio/prowlarr
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - /opt/prowlarr/config:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  freshrss:
    image: freshrss/freshrss:latest
    container_name: freshrss
    ports:
      - "8585:80"
    environment:
      - TRUSTED_PROXY=10.10.10.20/32
      - TZ=America/Chicago
      - CRON_MIN=*/20
    volumes:
      - /opt/freshrss/data:/var/www/FreshRSS/data
      - /opt/freshrss/extensions:/var/www/FreshRSS/extensions
    restart: unless-stopped

  beszel:
    image: henrygd/beszel:latest
    container_name: beszel
    restart: unless-stopped
    ports:
      - 8090:8090
    volumes:
      - /opt/beszel/data:/beszel_data
      - /opt/beszel/socket:/beszel_socket

  beszel-agent:
    image: henrygd/beszel-agent
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./beszel_agent_data:/var/lib/beszel-agent
    environment:
      LISTEN: 45876
      KEY: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIvGdArM62pH6FgaFBekiwNwQG5j+3DJZw8uApgVbNOn'
      TOKEN: 9cc42db8-410b-4da6-acaa-b3f597a49e67
      HUB_URL: http://192.168.1.25:8090

  homebridge:
    image: homebridge/homebridge:latest
    container_name: homebridge
    restart: always
    network_mode: host
    volumes:
      - /opt/homebridge/data:/homebridge
    logging:
      driver: json-file
      options:
        max-size: "10mb"
        max-file: "1"

  scrypted:
    environment:
      - SCRYPTED_WEBHOOK_UPDATE_AUTHORIZATION=Bearer ${WATCHTOWER_HTTP_API_TOKEN}
      - SCRYPTED_WEBHOOK_UPDATE=http://localhost:10444/v1/update
    image: ghcr.io/koush/scrypted
    volumes:
      - /opt/scrypted/volume:/server/volume
    container_name: scrypted
    restart: unless-stopped
    network_mode: host
    logging:
      driver: "none"
    labels:
      - "com.centurylinklabs.watchtower.scope=scrypted"
    dns:
      - ${SCRYPTED_DNS_SERVER_0:-192.168.1.1}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:11080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s      

  watchtower:
    environment:
      - WATCHTOWER_HTTP_API_TOKEN=${WATCHTOWER_HTTP_API_TOKEN}
      - WATCHTOWER_HTTP_API_UPDATE=true
      - WATCHTOWER_SCOPE=scrypted
      - WATCHTOWER_HTTP_API_PERIODIC_POLLS=${WATCHTOWER_HTTP_API_PERIODIC_POLLS:-true}
      - DOCKER_API_VERSION=1.44
    image: containrrr/watchtower:latest
    container_name: scrypted-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "com.centurylinklabs.watchtower.scope=scrypted"
    ports:
      - 10444:8080
    command: --interval 3600 --cleanup --scope scrypted
    dns:
      - ${SCRYPTED_DNS_SERVER_0:-192.168.1.1}

  wireguard:
    image: j4v3l/wireguard-dashboard:beta
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - TZ=America/Chicago
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - WG_HOST=${WG_HOST:-auto}
      - WG_PORT=${WG_PORT:-51820}
      - WG_DASHBOARD_PORT=${WG_DASHBOARD_PORT:-10086}
      - WG_DASHBOARD_HOST=${WG_DASHBOARD_HOST:-0.0.0.0}
      - WG_ALLOWED_IPS=${WG_ALLOWED_IPS:-0.0.0.0/0, ::/0}
      - WG_PERSISTENT_KEEPALIVE=${WG_PERSISTENT_KEEPALIVE:-25}
      - WG_DNS_SERVERS=${WG_DNS_SERVERS:-1.1.1.1,8.8.8.8}
      - AUTO_UPDATE=${AUTO_UPDATE:-false}
      - UPDATE_DASHBOARD=${UPDATE_DASHBOARD:-false}
    volumes:
      - /opt/wireguard/config:/etc/wireguard
      - /opt/wireguard/dashboard-data:/opt/WGDashboard/src/db
    restart: unless-stopped
    privileged: true
    healthcheck:
      test: ["CMD", "wg", "show"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  phpipam-mariadb:
    image: mariadb:latest
    container_name: phpipam-mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=${PHPIPAM_MYSQL_ROOT_PASSWORD}
      - TZ=America/Chicago
    volumes:
      - /opt/phpipam/db:/var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  phpipam-web:
    image: phpipam/phpipam-www:latest
    container_name: phpipam-web
    ports:
      - "8081:80"
    environment:
      - TZ=America/Chicago
      - IPAM_DATABASE_HOST=phpipam-mariadb
      - IPAM_DATABASE_PASS=${PHPIPAM_DATABASE_PASSWORD}
      - IPAM_DATABASE_WEBHOST=%
    volumes:
      - /opt/phpipam/logo:/phpipam/css/images/logo
      - /opt/phpipam/ca:/usr/local/share/ca-certificates:ro
    restart: unless-stopped
    depends_on:
      phpipam-mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  phpipam-cron:
    image: phpipam/phpipam-cron:latest
    container_name: phpipam-cron
    environment:
      - TZ=America/Chicago
      - IPAM_DATABASE_HOST=phpipam-mariadb
      - IPAM_DATABASE_PASS=${PHPIPAM_DATABASE_PASSWORD}
      - SCAN_INTERVAL=1h
    volumes:
      - /opt/phpipam/ca:/usr/local/share/ca-certificates:ro
    restart: unless-stopped
    depends_on:
      phpipam-mariadb:
        condition: service_healthy

  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"  # This maps the container port "3001" to the host port "3001"
    volumes:
      - /opt/uptimekuma:/app/data  # Configuring persistent storage
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=America/Chicago  # Set the timezone (change to your preferred local timezone so monitoring times are the same)
      - UMASK=0022  # Set your file permissions manually
    networks:
      - kuma_network  # add your own custom network config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001"]
      interval: 30s
      retries: 3
      start_period: 10s
      timeout: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mysql:
    image: mysql:8.0
    container_name: zabbix-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_bin
      - --default-authentication-plugin=mysql_native_password
      - --ssl-ca=/etc/mysql/certs/ca-cert.pem
      - --ssl-cert=/etc/mysql/certs/server-cert.pem
      - --ssl-key=/etc/mysql/certs/server-key.pem
    volumes:
      - /opt/zabbix-mysql:/var/lib/mysql
      - /home/harrison/zabbix-certs:/etc/mysql/certs:ro
    networks:
      zabbix-network:
        ipv4_address: 172.20.0.2

  zabbix-server:
    image: zabbix/zabbix-server-mysql:alpine-7.4-latest
    container_name: zabbix-server
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: mysql
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      ZBX_WEBSERVICEURL: http://zabbix-web-service:10053/report
      ZBX_DBTLSCONNECT: required
      ZBX_DBTLSCAFILE: /etc/mysql/certs/ca-cert.pem
    ports:
      - "10051:10051"
    volumes:
      - /opt/zabbix-server:/var/lib/zabbix
      - /home/harrison/zabbix-certs:/etc/mysql/certs:ro
    depends_on:
      - mysql
    networks:
      zabbix-network:
        ipv4_address: 172.20.0.3

  zabbix-web:
    image: zabbix/zabbix-web-nginx-mysql:alpine-7.4-latest
    container_name: zabbix-web
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: mysql
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      ZBX_SERVER_HOST: ${ZBX_SERVER_HOST}
      PHP_TZ: ${PHP_TZ}
    ports:
      - "80:8080"
    depends_on:
      - mysql
      - zabbix-server
    networks:
      zabbix-network:
        ipv4_address: 172.20.0.4

  zabbix-web-service:
    image: zabbix/zabbix-web-service:alpine-7.4-latest
    container_name: zabbix-web-service
    restart: unless-stopped
    environment:
      ZBX_ALLOWEDIP: zabbix-server
    ports:
      - "10053:10053"
    cap_add:
      - SYS_ADMIN
    networks:
      zabbix-network:
        ipv4_address: 172.20.0.5

networks:
  kuma_network:
    driver: bridge
  zabbix-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
